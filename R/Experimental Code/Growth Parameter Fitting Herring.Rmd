---
title: "Growth Parameter Fitting Herring"
author: "Richard Southwell"
date: "21 July 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Outline

In his VB paper Mike used empirical data $x = \{ (a_i,l_i) : i \in \{1,..,N \} \}$ where $a_i$ is number of winters that the $i$th fish caught has survived, and $l_i$ is this fish's length.

In this report we focus on sampling from the posterior $p(\theta|k,F_x(.)),$ where $\theta =(h,\gamma,W_{\infty})$ are the growth parameters we shall run mizer with to generate simulated (age,length) data $m_E(\theta) = \{ (a_i ^*,l_i ^*) : i \in \{1,..,M \} \}$, where, currently, $a_i ^* = i \times \Delta t,$ and $l_i ^*,$ is mizer's prediction of the length of an age $a_i ^*$ Herring. Here $w_i ^* = \alpha \times (l_i ^*)^\beta,$ is the weight mizer predicts, by solving the equation $\frac{dw}{dt}=g(w,t),$ using the growth rates $g(w,t)$ generated by mizer as it evolves, under dynamic fishing efforts $E$ from years 1966 to 2010, as used in Mike's earlier paper on mizer. I suggest creating realistic initial conditions by starting from any initial size-spectrum-state and running the thing with efforts $E$ repeating end-to-end over time until the mizer dynamics go into a periodic orbit of the same period as $E.$

We write $k$ as shorthand to denote the von Bertalanffy (VB) parameters $k = (K,l_{\infty},t_0)$ corresponding to the VG growth model.

In previous work mike generated samples from $p(k|x),$ these give us an estimate $F_x(k) \approx p(k|x)$ of the posterior distribution of the VB parameters $k,$ given the empirical landings data $x.$ 

We wish to sample from $p(\theta|k,F_x(.)),$ which is the posterior distribution of the parameter $\theta,$ given VB parameters $k,$ under the assumption that $k$ is distributed according to distribution $F_x$ that was constructed using the empirical data $x.$

According to Bayes theorem $p(\theta|k,F_x(.)) \propto p(\theta)p(k|\theta,F_x(.)),$ 
where the likelihood can be rewritten as $$p(k|\theta,F_x(.)) = F_x(k_{best}[m(\theta)]),$$ where $k_{best}[m(\theta)])$ consists of the VB parameters that best fit the (age,length) data $m(\theta)$ which mizer generated.

So we write our target posterior distribution as 

$$p(\theta|k,F_x()) \propto p(\theta) F_x(k_{best}[m(\theta)])$$
At the moment I am using improper priors, and sampling using MCMC.

## Code

Initialization code (copy and paste into consol).

```{r,eval=FALSE}
library(devtools)
library(ggplot2)
library(grid)
library(methods)
library(plyr)
library(reshape2)
library(mizer)
library(deSolve)
load("Herring.Rdata")
#out is name of this data = k, Linf, 
library(mvtnorm)

a <- 0.006
b <- 3.05

out2 <- out
out2[,2] <- out[,2]/10
SIGMA<-cov(out2[,1:3])
MU<-colMeans(out2[,1:3])



params_data <- read.csv("./vignettes/NS_species_params.csv")
inter <- read.csv("./vignettes/inter.csv", row.names=1)
inter <- as(inter, "matrix")
mytimes <- seq(0,100,0.1)
param1 <- MizerParams(params_data, interaction = inter, no_w = 100)
test<-project(param1,effort=0.5,t_max = 3, dt = 0.25, t_save = 1)
```

Here `out2` is a list of mike's samples $(K,l_\infty,t_0)=k$ from $p(k|x).$

change to add t0

## Notes


I think mike's previous work assumed $t0=0$, so perhaps we should re-adjust our growth curves so that fish begin to grow at size zero. Or fit $t0$ as well.  I was wondering if we need to make the assumption that t0 =0. If this case the VB parameter fitting will work under the assumption that the fish is size 0 at age 0. However, to correspond to this, we should need to simulate how fish grow from size 0 in mizer. The issue is, I think it could be hard to get the growth rates for fish below egg size, as mizer is not designed to work in that regime, and it does not make as much physical sense to try and model the feeding habits of sub-egg-sized fish. I wonder if one way around this would be to also include t0 as an extra parameter we should fit (I guess I can do this using column 3 of herring.Rdata). Currently my mizer-generated time vs length plots work under the assumption that the fish is egg sized at t=0.

I need to include dynamic growth rates, include fitting of t0, and setup MCMC, and run it for herring.

