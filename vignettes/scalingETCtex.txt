% Preview source code

%% LyX 2.2.3 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[english]{article}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{amstext}
\usepackage{amssymb}
\usepackage{esint}
\usepackage{babel}
\begin{document}

\title{Mathematics Behind The New Mizer}

\author{Richard Southwell}
\maketitle

\section*{set\_scaling\_model()}

set\_scaling\_model() is a procedure in mizer for making a size spectrum
model.

.

\subsection*{Inputs}

The scale invariant size spectrum model generated by $\textit{set\_scaling\_model()}$
depends upon the following inputs:
\begin{itemize}
\item The number of species $\textit{no\_sp}=s$. By default this is 11.
\item The minimum asymptotic size $\textit{min\_w\_inf}=W_{\infty}^{L}=\min\left\{ W_{\infty.i}:i\in\left\{ 1,..,s\right\} \right\} $.
By default this is 10
\item The maximum asymptotic size $\text{max\_w\_inf}=W_{\infty}^{H}=\max\left\{ W_{\infty.i}:i\in\left\{ 1,..,s\right\} \right\} $.
By default this is $10^{3}$
\item The minimum egg size min\_egg=$w_{e}^{L}=\min\left\{ w_{e.i}:i\in\left\{ 1,..,s\right\} \right\} $.
By default this is $10^{-4}$
\item The minimum maturity weight $\textit{min\_w\_mat}=w_{*}^{L}=\min\left\{ w_{*i}:i\in\left\{ 1,..,s\right\} \right\} $.
By default this is $10^{0.4}$
\item The number of weight bins no\_w = $K.$ By default this is $1+100\log_{10}\left(\frac{W_{\infty}^{H}}{w_{e}^{L}}\right)$ 
\item The minimum weight of plankton modeled, $W_{min}^{P}$ min\_w\_pp
is set to $\frac{\min\left\{ w_{e.i}:i\in\left\{ 1,..,s\right\} \right\} }{\beta e^{5\sigma}}$
by default.
\item The maximum weight of modeled plankton w\_pp\_cutoff=$w_{cut}.$ By
default this is $W_{\infty}^{L}.$ {[}We ensure that the plankton's
carrying capacity $c_{p}(w)$ has the feature that $w>w_{cut}$ implies
$c_{p}(w)=0.${]}
\item The exponent of the maximum consumption rate (also known as the `the
scaling of intake'), $n$ . By default this is $2/3$.
\item The scaling of standard metabolism, $q$. By default this is $3/4$
\item The exponent $\lambda$ of the background spectrum. By default this
is $2+q-n$
\item The growth rate of the primary productivity (the background spectrum),
r\_pp=$r_{0}$. By default this is $0.1$.
\item The pre-multiplier of the community spectrum power law $\kappa$.
By default this is $0.005$.
\item The assimilation efficiency $\alpha$. By default this is 0.4
\item Multiplicative constant for std. metabolism and activity, $k_{s}.$By
default this is $4$
\item Multiplicative constant for max. food intake, $h.$ By default this
is $30.$
\item Preferred predator prey mass ratio $\beta.$ By default this is $100.$ 
\item Width of prey size preference $\sigma.$ By default this is 1.3. 
\item Initial feeding level $f_{0}.$ By default this is $0.6$
\item The size beyond which the knife edge gear catches (if that is what
is setup for fishing), knife\_edge\_size. The default for this is
100 {[}I think this is a weight, and not a length, any may not be
relevant depending on the gear names{]}.
\item The name of the gear, gear\_names. By default this is \textquotedbl{}knife\_edge\_gear\textquotedbl{},
indicating to mizer to setup the fishing selectivity using knife edge
gears.
\item The factor $R_{fac}$ such that $R_{max.i}$ =$R_{i}R_{fac}$, for
each species $i.$ Here $R_{max}$ is the maximum recruitment allowed
and $R_{i}$ is the steady-state recruitment. {[}Thus the larger $R_{fac}$
the less the impact of the non-linear stock-recruitment curve.{]}
By default this is $\infty.$
\item A Boolean variable `perfect'. By default perfect=FALSE. If perfect=TRUE
then parameters are set so that the community abundance, growth before
reproduction and death are perfect power laws.
\end{itemize}

\subsection*{Procedure}

\subsubsection*{Tidy up inputs and check validity}
\begin{itemize}
\item If community exponent $\lambda$ was given as an input then the exponent
for volumetric search rate $q$ is rewritten so $q:=\lambda-2+n,$
where $n$ is the exponent for max. food intake.
\item If $R_{fac}\leq1$ then $R_{fac}:=1.01.$
\item The number of weight bins $K$ is replaced with the nearest integer
to $K$
\item Let $T:=round\left(5\log_{10}\left(\frac{W_{\inf}^{H}}{w_{e}^{L}}\right)+1\right).$
If $K<T$ then $K:=T$ {[}this is done so there are at least $5$
bins in the interval from $w$ to $10w$ {[}is this true for any w,
or only w=w\_e etc. ?{]}.
\item Check that $K\leq10,000$ and $W_{\infty}^{L}<W_{\infty}^{H}$ and
$w_{e}^{L}<w_{*}^{L}$and $s\geq2$ and n, q, r\_pp, kappa, alpha,
h, beta, sigma, ks, f0, knife\_edge\_size>0 If any of these conditions
are false then give a warning message, and halt.
\item If perfect=TRUE then let $w_{cut}:=\infty$
\end{itemize}
.

\subsubsection*{Define variables}
\begin{itemize}
\item Set the exponent of standard metabolism to be $p:=n$
\item $\lambda:=2+q-n$
\item Define the smallest weight we model fish at to be $W^{L}:=w_{e}^{L}$.
\item Define the largest weight we model fish at to be $W^{H}:=W_{\infty}^{H}$
\item To round the minimum maturity weight $w_{*}^{L}$ up to a grid point
we let $\delta=\frac{\log_{10}(W^{H})-\log_{10}(W^{L})}{K-1}$ and
$j=1+\left\lceil \frac{\log_{10}(w_{*}^{L})-\log_{10}(W^{L})}{\delta}\right\rceil $
and $v=10^{\log_{10}(W^{L})+(j-1)\delta}$ and we round the minimum
maturity weight up by letting $w_{*}^{L}:=v.$
\item To round the minimum asymptotic weight $w_{\infty}^{L}$ to the nearest
grid point we and $J=1+\left\lceil \frac{\log_{10}(W^{H})-\log_{10}(W_{\infty}^{L})}{\delta(s-1)}\right\rceil $
where $s$ is the number of species. We let $W_{\infty}^{L}:=10^{\log_{10}(W^{H})-J(s-1)\delta}.$
{[}actually is a round() function used here instead ? maybe we should
use the same approach in more places{]}.
\item Prepare to setup egg weights: Let $I[e,i]\in\left\{ 1,..,K\right\} $
denote the index of the weights that corresponds with the weight such
that $w_{I[e,i]}=w_{e.i}.$ We set $(I[e,1],I[e,2],..,I[e,s]):=(1,J+1,2J+1,..,(s-1)J+1).$
\item We set the maximum egg size to be $w_{e}^{H}=w_{e}^{L}\left(\frac{W^{H}}{W_{\infty}^{L}}\right).$
\item Determine logarithmic spacing of egg weights $\Delta=\frac{\log_{10}(w_{e}^{H})-\log_{10}(w_{e}^{L})}{s-1}.$
\item Let $(x_{e.1},x_{e.2},..,x_{e.s})=(\log_{10}(w_{e}^{L}),\log_{10}(w_{e}^{L})+\Delta,..,\log_{10}(w_{e}^{L})+(s-1)\Delta).$
The egg weight of background species $i$ is set to $w_{e.i}:=10^{x_{e.i}}.$ 
\item The asymptotic weight of background species $i$ is set to $W_{\infty.i}:=w_{e.i}\left(\frac{W_{\infty}^{L}}{w_{e}^{L}}\right).$
\item The maturity weight of background species $i$ is set to $w_{*i}:=w_{e.i}\left(\frac{w_{*}^{L}}{w_{e}^{L}}\right).$
\item The value of the reproduction efficiency is set to $\epsilon=0.1,$
although it is overwritten later.
\end{itemize}

\subsubsection*{Setting up the data structure}
\begin{itemize}
\item A data-frame $\mathbb{F}$ is made holding the species-specific information,
together with a declaration that $z_{0}=0,$ {[}where $z_{0}$ is
the pre-multiplier of mizer's traditional background death term I
presume{]}, however we do use a different type of background death
term that is described later. The other information included in the
data frame are the names of the species, $1,..,s$ and w\_min, w\_inf,
w\_mat, w\_min\_idx, h, ks, beta, sigma, alpha, erepro, sel\_func
= \textquotedbl{}knife\_edge\textquotedbl{}, knife\_edge\_size = knife\_edge\_size,
gear = gear\_names.
\item A mizer params object $\mathbb{P}$ is made by using $\mathbb{F}$
and $p,n,q,\lambda,f_{0},\kappa,W^{L},W^{H},K,W_{min}^{P},w_{cut},r_{0}$
as inputs to MizerParams(). Here $W_{min}^{P}$ is the minimum weight
of plankton modeled, and $r_{0}$ is the replenishment rate of the
plankton. The values of $\gamma,w$ and $dw$ are (re)computed by
calling MizerParams(), and we use such updated values.
\end{itemize}

\subsubsection*{Steady state solution for species one}
\begin{itemize}
\item Compute coefficient of predation death rate that would be induced
by a power law spectrum of background species: $\mu_{0}:=(1-f_{0})\sqrt{2\pi}\kappa\gamma\sigma\beta^{n-1}\exp\left(\sigma^{2}(n-1)^{2}/2\right)$
\item Compute coefficient of energy available for reproduction and growth,
at power law state $\hbar:=\alpha hf_{0}-k_{s}.$ If $\hbar<0$ then
halt.
\item We define pow=$B:=\frac{\mu_{0}}{\hbar(1-n)},$ and if $B<1$ then
an error message is displayed about how at steady state the ratio
of death rate to growth rate is too small, leading to an accumulation
of fish at their largest size.{[}check the 1-n really goes on the
denominator{]}.
\item The death rate at steady state is $\mu(w):=\mu_{0}w^{n-1}$
\item The growth rate of species $1$ at steady state is $g(w):=\hbar w^{n}(1-\psi_{1}(w)),$
where $\psi_{1}(w)$ is the fraction of their energy that a weight
$w$ member of species $1$ diverts to reproduction.
\item Let $I[\infty,i]$ denote the index such that $w_{I[\infty,i]}=W_{\infty.i}$,
that gives the asymptotic weight of the $i$th species. Let $\mathbb{I}=\left\{ 1,2,..,I[\infty,1]-1\right\} $
\item The unscaled steady state abundance $\widehat{N_{1}}(w)$ of species
$1$ is such that $\widehat{N_{1}}(w_{1})=1,$ and for each $j\in\left\{ 2,..,K\right\} $
we have that $\widehat{N_{1}}(w_{j})=0$ if $j>I[\infty,1]$ and otherwise,
$(\widehat{N_{1}}(w_{1}),\widehat{N_{1}}(w_{2}),\widehat{N_{1}}(w_{3}),..,\widehat{N_{1}}(w_{K}))$
is set equal to $(1,H[1],H[2],..,H[I[\infty,1]-1],0,0,..,0)$. Here
$H[k]==\Pi_{u=1}^{k}\frac{g(w_{u})}{g(w_{u+1})+\mu(w_{u+1})dw_{u+1}}$
{[}This is to match with the steady state of the upwind difference
scheme, but I'd better check I've got the indices correct, etc., and
simplify{]}.
\item Rescale the abundance of species $1$ so it lies on a power law. Let
$M=\kappa/\sum_{j=1}^{I[\infty,1]}\widehat{N_{1}}(w_{j})w_{j}^{\lambda-1}dw_{j}$
be the multiplier, and generate the properly scaled abundance of species
$1,$ which we set to be $N_{1}^{*}(w):=\widehat{N_{1}}(w)(10^{\Delta(1-\lambda)/2}-10^{-\Delta(1-\lambda)/2})M/(1-\lambda).$
{[}I am not sure where the $(10^{\Delta(1-\lambda)/2}-10^{-\Delta(1-\lambda)/2})$
renormalization factor comes from{]}
\end{itemize}

\subsubsection*{Finish computing steady state solution}
\begin{itemize}
\item Initially set $N_{i}(w_{j})=0$
\item For each species $i\in\left\{ 1,..,s\right\} $ let $I[e,i]$ be the
egg weight index, so $w_{I[e,i]}=w_{e.i}$ and the list of indices
which we shall fill abundance values into is $\mathbb{I}=\left(I[e,i],I[e,i]+1,..,I[e,i]+\left\Vert N_{1}^{*}()\right\Vert -1\right),$
where $\left\Vert N_{1}^{*}()\right\Vert =I[\infty,1]$ is the number
of size bins that get (potentially) non-zero abundance values loaded
into them, during the previous construction of the steady state solution.
\item Now we use our scale invariant transformation to construct the steady
state abundance of the $i$th species. This is done by setting $N_{i}(w_{\mathbb{I}[k]})=N_{1}^{*}(w_{k})\left(\frac{w_{e.1}}{w_{e.i}}\right)^{\lambda}$
for each $k\in\left\{ 1,..,|\mathbb{I}|\right\} ,$ where $|\mathbb{I}|$
is the number of indices in our list. 
\item We compute the community spectrum $N_{c}(w):=\sum_{i=1}^{s}N_{i}(w)$
and save it as part of the MizerParams object $\mathbb{Q}$ that we
will return from this procedure. 
\end{itemize}

\subsubsection*{Setup Plankton}
\begin{itemize}
\item Define the `plankton vector' to be $N^{P}(w)=\kappa w^{-\lambda}-N_{c}(w)$
to be the required abundance to fill up to the power law, over the
interval of weights where fish are modeled. 
\item Cutoff the plankton vector above $w_{cut}$ so if $w\geq w_{cut}$
then $N^{P}(w)=0.$ If perfect=FALSE then any negative entries generated
in $N^{P}(w)$ are replaced with zeros.
\item Let the abundance of plankton (that will be) at steady state $N_{R}(w')$
be replaced with $N^{P}(w')$ for each weight $w'$ in the fish weight
interval.
\item The carrying capacity $c_{p}(w)$ is defined from the minimum plankton
weight, all the way to the maximum fish size. For the weights $w'$
over the sizes at which fish are modeled we set $c_{p}(w')=N^{P}(w')\frac{r(w')+\mu_{R}(w')}{r(w')}$
where $r(w)=r_{0}w^{p-1}$ is the replenishment rate of the plankton,
and $\mu_{R}(w'$) is the death rate on the plankton, in the presence
of fish with abundance as described by $N_{i}(w).$
\end{itemize}

\subsubsection*{Setup background death}
\begin{itemize}
\item Let $\mu_{P.i}(w)$ be the predation mortality rate.
\item For each species $i$ set the background death to be $\mu_{B.i}(w)=\mu_{0}w^{n-1}-\mu_{P.i}(w),$
and if perfect=FALSE then replace negative background death values
with zeros. 
\end{itemize}

\subsubsection*{Make egg count match newborn abundance}
\begin{itemize}
\item Let $R_{p.i}=\frac{\epsilon}{2w_{e.i}}\int_{0}^{\infty}N_{i}(w)E_{r.i}(w)\psi_{i}(w)dw$
denote the total production of eggs for breeders of species $i$.
\item Let $g_{i}(w)$ be the growth rate of species $i$
\item Let $\mu_{i}(w)$ be the total death rate of species $i$ 
\item For each species $i,$ we replace the value of the reproductive efficiency
with the value $\epsilon_{i}^{*}=\epsilon_{i}N_{i}(w_{e.i})(g_{i}(w_{e.i})+dw_{I[e.i]}\mu_{i}(w_{e.i}))/R_{p.i}$
where $\epsilon_{i}$ is the old value of the reprodution efficiency. 
\item If $R_{fac}=\infty$ then $\epsilon_{i}^{*}$ is used as the value
of the reproduction efficiency. Otherwise, if $R_{fac}$ is finite
then the final value of the reproduction efficiency is $\left(\frac{R_{fac}}{R_{fac}-1}\right)\epsilon_{i}^{*}.$
This is to compensate for using a stock recruitment relationship. 
\item Add $N_{R}(w),N_{i}(w),\epsilon$ to our MizerParams object $\mathbb{P}$ 
\item Use these values to find $R_{p.i}^{*}=\frac{\epsilon}{2w_{e.i}}\int_{0}^{\infty}N_{i}(w)E_{r.i}(w)\psi_{i}(w)dw$
and reset the stock recruitment relationship so $R_{max.i}=(R_{fac}-1)R_{p.i}^{*}.$
\end{itemize}

\end{document}

