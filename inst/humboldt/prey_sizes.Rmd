---
title: "Prey sizes of Anchovy and Sardine"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

Mariella has data of stomach content for anchovy and sardine. Here we look at
estimating the predation kernel from this data.

## The data

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
ppmr <- read_csv("Data_PPMR.csv")
ppmr
```

The `wprey` variable is the typical weight of an individual of
a particular prey species and `Nprey` is the average number of individuals
of that species in a stomach and `wpredator` is the weight of the predator.

We see that the capitalisation of the species names is wrong. Let's fix that
and also add a column for the log of the predator/prey mass ratio.
```{r}
ppmr <- ppmr %>% 
  mutate(Species = str_to_title(Species),
         logpredprey = log(wpredator / wprey))
ppmr
```

## Binned data
Let's bin the data
```{r}
params <- readRDS("params0707.rds")
dx <- log(params@w[2]/params@w[1])
binsize <- 15 * dx
breaks <- seq(0, length(params@w_full), by = binsize / dx) * dx
binned_ppmr <- ppmr %>% 
    # bin data
    mutate(cut = cut(logpredprey, breaks = breaks, right = FALSE,
                     labels = FALSE)) %>% 
    group_by(Species, cut) %>% 
    summarise(Numbers = sum(Nprey), 
              Biomass = sum(Nprey * wprey)) %>% 
    # normalise
    mutate(Numbers = Numbers / sum(Numbers) / binsize,
           Biomass = Biomass / sum(Biomass) / binsize)  %>%
    # column for predator/prey size ratio
    mutate(r = map_dbl(cut, function(idx) exp(breaks[idx]))) %>%
    gather(key = "Type", value = "Density", Numbers, Biomass)
```
and plot it:
```{r}
binned_ppmr %>% 
  ggplot(aes(r, Density)) +
    geom_col() +
    facet_grid(Species ~ Type, scales = "free_y") +
    scale_x_log10(name = "Predator/Prey mass ratio") 
```

Note how the biomass of prey is concentrated at very different predator/prey mass ratio
than the number of prey.

Many observations are too small to show in the above graph. We therefore show
the same graphs with a logarithmic y-axis
```{r}
binned_ppmr %>% 
  ggplot(aes(r, Density)) +
    geom_col() +
    facet_grid(Species ~ Type, scales = "free_y") +
    scale_x_log10(name = "Predator/Prey mass ratio") +
    scale_y_log10()
```

## Kernel from data
We want to use this data to estimate the feeding kernel. To
make a connection we assume that the abundance of a prey size in a predator's
stomach is proportional to the product of the rate at which the predator feeds
on prey of that size with the length of time it takes to digest a prey of that
size. For a predator of size $w'$ and species $i$ the rate at which it predates
on prey of size $w$ is proportional to $\phi(w/ w')N(w)$ where $N(w)$ is the
abundance of all prey of size $w$, 
$$N(w)=\sum_j\theta_{ij}N_j(w),$$ 
and $\phi(w/w')$ is the feeding kernel. We assume that the time until digestion
is proprtional to $w^\alpha$ for some positive exponent $\alpha$. A sensible
choice might be to say that the time until digestion is proportional to the
ratio of volume to surface area, which would lead to an exponent of 
$\alpha = 1 - 2/3 = 1/3$.
```{r}
alpha <- 1/3
```

So, up to a $w'$-dependent normalisation, the probability density function for a
prey item to have size $w$ given that the predator has size $w'$ is
$$f_w(w|w') \propto \phi(w/ w')N(w)w^\alpha.$$

The probability density function for the log of the predator/prey mass ratio
$l=\log(w'/w)$ is then
$$ f_l(l|w') = f_w(w|w')\left|\frac{dw}{dl}\right|.$$
Because $w = w' e^{-l}$ we find $|dw/dl|=w$ and thus
$$f_l(l|w') = w f_w(w|w')\propto\phi(e^{-l})N(w)w^{1+\alpha}.$$
So we can obtain the feeding kernel from the conditional probability density 
given $w'$ as
$$\phi(w/w') =\phi(e^{-l})\propto \frac{f_l(l|w')}{w^{1+\alpha}N(w)}
\propto\frac{f_l(l|w')}{e^{-l(1+\alpha)}N(w' e^{-l})}.$$

We can estimate the feeding kernel from the stomach data by picking a size $w'$
and making a histogram of the observed predator/prey mass ratios for all
predators of that size, rescaled by the denominator in the above equation. Mizer
makes the assumption that the feeding kernel depends only on the predator/prey
mass ratio and not separately also on the predator size, so it does not matter
which predator size $w'$ we pick. To get a better estimate we can simply combine
the data from all predator sizes into a single histogram (corresponding to
taking the average of all the individual bar heights).

For the prey abundance $N(w)$ we can either use the steady state abundance
in a calibrated mizer model, or we can use the approximate power-law
abundance $N(w) \propto w^{-\lambda}$. We calculate the kernel with either 
choice and then observe that they lead to similar results.
```{r warning=FALSE}
idx_sp <- seq_along(params@w) + length(params@w_full) - length(params@w)
prey <- outer(params@species_params$interaction_p, params@initial_n_pp)
prey[, idx_sp] <- prey[, idx_sp] + params@interaction %*% params@initial_n
rownames(prey) <- params@species_params$species
vals <- ppmr %>% 
    # Add index of size bracket of prey
    mutate(idx = map_int(wprey, function(w) sum(params@w_full < w))) %>% 
    filter(idx > 0) %>% 
    mutate(k = pmap_dbl(list(Nprey, Species, idx, wprey),
                        function(Nprey, Species, idx, wprey) {
                          Nprey / prey[Species, idx] / wprey^(1 + alpha)
                        }),
           kp = Nprey / wprey^(1 + alpha - params@lambda))

kernel <- vals %>% 
    # bin data
    mutate(cut = cut(logpredprey, breaks = breaks, right = FALSE,
                     labels = FALSE)) %>% 
    group_by(Species, cut) %>% 
    summarise(Model = sum(k), 
              Theory = sum(kp)) %>% 
    # normalise
    mutate(Model = Model / sum(Model) / binsize,
           Theory = Theory / sum(Theory) / binsize)  %>%
    # column for predator/prey size ratio
    mutate(r = map_dbl(cut, function(idx) exp(breaks[idx]))) %>% 
    gather(key = "Type", value = "Density", Model, Theory)
```


```{r}
kernel %>% 
    ggplot(aes(r, Density)) +
    geom_col() +
    facet_grid(Species ~ Type, scales = "free_y") +
    scale_x_log10(name = "Predator/Prey mass ratio")
```

It is very difficult to see what to make of this. With a log axis it looks
like this:
```{r}
kernel %>% 
    ggplot(aes(r, Density)) +
    geom_col() +
    facet_grid(Species ~ Type, scales = "free_y") +
    scale_x_log10(name = "Predator/Prey mass ratio") +
    scale_y_log10()
```

## Density estimates
It turns out that instead of working with histograms of the binned data, we can 
also look at the data via density estimates. Here is the smoothed density estimate for
the abundance density and the biomass density in the stomach:
```{r}
ppmr <- ppmr %>% 
    group_by(Species) %>% 
    mutate(weight = Nprey / sum(Nprey),
           weight_biomass = Nprey * wprey / sum(Nprey * wprey))
ggplot(ppmr) +
    geom_density(aes(logpredprey, weight = weight)) +
    facet_wrap(~Species, scales = "free_y") +
    xlab("Log of predator/prey mass ratio") 
```
```{r}
ggplot(ppmr) +
    geom_density(aes(logpredprey, weight = weight_biomass)) +
    facet_wrap(~Species, scales = "free_y") +
    xlab("Log of predator/prey mass ratio") +
    ylab("Biomass density")
```
And here is the predation kernel estimated from the data using the power law prey abundance:
```{r}
ppmr <- ppmr %>% 
    mutate(weight_kernel = Nprey / wprey^(1 + alpha - params@lambda),
           weight_kernel = weight_kernel / sum(weight_kernel))

ggplot(ppmr) +
    geom_density(aes(logpredprey, weight = weight_kernel)) +
    facet_wrap(~Species, scales = "free_y") +
    xlab("Log of predator/prey mass ratio") +
    ylab("Predation kernel") +
    expand_limits(x = 0)
```
```{r}
sigmoid <- function(x, p, s) {
  1/(1 + exp((p - x) / s))
}
double_sigmoid <- function(x, p_l, s_l, p_r, s_r, ex) {
  sigmoid(x, p_l, s_l) *
    exp(-ex * x) *
    sigmoid(-x, -p_r, s_r)
}
ggplot(data.frame(x = c(0, 25)), aes(x)) +
  stat_function(fun = double_sigmoid, 
                args = list(p_l = 5, s_l = 0.5, p_r = 15, s_r = 1, ex = 0.1))
```


