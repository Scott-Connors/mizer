---
title: "Prey sizes of Anchovy and Sardine"
output:
  pdf_document: default
  html_notebook: default
---

Mariella has data of stomach content for anchovy and sardine.
Let's load it

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
ppmr <- read_csv("Data_PPMR.csv")
ppmr
```

The `wprey` variable is the typical weight of an individual of
a particular prey species and `Nprey` is the average number of individuals
of that species in a stomach and `wpredator` is the weight of the predator.

We see that the capitalisation of the species names is wrong. Let's fix that
and also add a column for the log of the predator/prey mass ratio.
```{r}
ppmr <- ppmr %>% 
  mutate(Species = str_to_title(Species),
         logpredprey = log(wpredator / wprey))
ppmr
```

We want to compare the stomach data to the prediction from the mizer model. To
make a connection we assume that the abundance of a prey size in a predator's
stomach is proportional to the product of the rate at which the predator feeds
on prey of that size with the length of time it takes to digest a prey of that
size. For a predator of size $w'$ and species $i$ the rate at which it predates
on prey of size $w$ is proportional to $\phi(w/ w')N(w)$ where $N(w)$ is the
abundance of all prey of size $w$, 
$$N(w)=\sum_j\theta_{ij}N_j(w),$$ 
and $\phi(w/w')$ is the feeding kernel. We assume that the time until digestion
is proprtional to $w^\alpha$ for some positive exponent $\alpha$. A sensible
choice might be to say that the time until digestion is proportional to the
ratio of volume to surface area, which would lead to an exponent of 
$\alpha = 1 - 2/3 = 1/3$.
```{r}
alpha <- 1/3
```

So, up to a $w'$-dependent normalisation, the probability density function for a
prey item to have size $w$ given that the predator has size $w'$ is
$$f_w(w|w') \propto \phi(w/ w')N(w)w^\alpha.$$

The probability density function for the log of the predator/prey mass ratio
$l=\log(w'/w)$ is then
$$ f_l(l|w') = f_w(w|w')\left|\frac{dw}{dl}\right|.$$
Because $w = w' e^{-l}$ we find $|dw/dl|=w$ and thus
$$f_l(l|w') = w f_w(w|w')\propto\phi(e^{-l})N(w)w^{1+\alpha}.$$
So we can obtain the feeding kernel from the conditional probability density 
given $w'$ as
$$\phi(w/w') =\phi(e^{-l})\propto \frac{f_l(l|w')}{w^{1+\alpha}N(w)}
\propto\frac{f_l(l|w')}{e^{-l(1+\alpha)}N(w' e^{-l})}.$$

We can estimate the feeding kernel from the stomach data by picking a size $w'$ and making a histogram
of the observed predator/prey mass ratios for all predators of that size, rescaled by 
the denominator in the above equation. Mizer makes the assumption that the
feeding kernel depends only on the predator/prey mass ratio and not separately also 
on the predator size, so it does not matter which predator size $w'$ we pick. To
get a better estimate we can simply combine the data from all predator sizes into
a single histogram (corresponding to taking the average of all the individual bar hights).
We will want to compare the resulting histogram to the usual choice in mizer of
$$\phi(w/w') =\phi(e^{-l}) \propto \exp\left(-\frac{(l-\log\beta)^2}{2\sigma^2}\right)$$


We calculate the bar heights ourselves, even though I am sure ggplot2 could
do it for us.
```{r warning=FALSE}
params <- readRDS("params0707.rds")
idx_sp <- seq_along(params@w) + length(params@w_full) - length(params@w)
prey <- outer(params@species_params$interaction_p, params@initial_n_pp)
prey[, idx_sp] <- prey[, idx_sp] + params@interaction %*% params@initial_n
rownames(prey) <- params@species_params$species
dx <- log(params@w[2]/params@w[1])
breaks <- (0:length(params@w_full)) * dx
test <- ppmr %>% 
    # Add index of size bracket of prey
    mutate(idx = map_int(wprey, function(w) sum(params@w_full < w))) %>% 
    filter(idx > 0) %>% 
    mutate(n = pmap_dbl(list(Nprey, Species, idx, wprey),
                        function(Nprey, Species, idx, wprey) {
                          Nprey / prey[Species, idx] / wprey^(1 + alpha)
                        })) %>% 
    mutate(cut = cut(logpredprey, breaks = breaks, right = FALSE,
                     labels = FALSE)) %>% 
    group_by(Species, cut) %>% 
    summarise(numbers = sum(Nprey)) %>% 
    separate(cut, into = c(NA, "w", "right", NA), 
             sep = "[\\[,\\)]", convert = TRUE, remove = FALSE) %>% 
    mutate(dw = right - w,
           density = numbers / dw) %>% 
    select(Species, w, dw, density)
```

We do not know
of a nice way to do this in R, so we use some ugly looping code.
```{r}
no_bins <- 30
bins <- seq(from = min(log(ppmr$wprey)) - 2, to = max(log(ppmr$wprey)) + 2,
            length.out = no_bins)
bin_width <- bins[2] - bins[1]
long_bins <- c(bins, bins[length(bins)] + bin_width)

count_anchovy <- bins
biomass_anchovy <- bins
count_sardine <- bins
biomass_sardine <- bins
for (t in (1:length(bins))) {
    in_bin <- long_bins[t] <= log(ppmr$wprey) & 
              log(ppmr$wprey) < long_bins[t + 1]
    count_anchovy[t] <- sum(ppmr$Nprey[in_bin & ppmr$Species == "anchovy"])
    biomass_anchovy[t] <- sum(ppmr$Nprey[in_bin & ppmr$Species == "anchovy"] *
                                  exp(bins[t]))
    count_sardine[t] <- sum(ppmr$Nprey[in_bin & ppmr$Species == "sardine"])
    biomass_sardine[t] <- sum(ppmr$Nprey[in_bin & ppmr$Species == "sardine"] *
                                  exp(bins[t]))
}

binned_anchovy <- 
    tibble(Species = "anchovy",
           Weight = log10(exp(bins)),
           Abundance = count_anchovy / sum(count_anchovy),
           f_logw = dnorm(bins, 
                          mean = moments$mean[moments$Species == "anchovy"],
                          sd = moments$sigma[moments$Species == "anchovy"]),
           Biomass = biomass_anchovy / sum(biomass_anchovy)) %>%
    mutate(b_logw = f_logw * exp(bins) / sum(f_logw * exp(bins)))

binned_sardine <- 
    tibble(Species = "sardine",
           Weight = log10(exp(bins)),
           Abundance = count_sardine / sum(count_sardine),
           f_logw = dnorm(bins, 
                          mean = moments$mean[moments$Species == "sardine"],
                          sd = moments$sigma[moments$Species == "sardine"]),
           Biomass = biomass_sardine / sum(biomass_sardine)) %>%
    mutate(b_logw = f_logw * exp(bins) / sum(f_logw * exp(bins)))

binned <- rbind(binned_anchovy, binned_sardine) %>%
    group_by(Species)
                
```

We can now plot the histogram for the observed abundances in the stomach 
together with the fitted model distribution.
```{r}

ggplot(binned) +
    geom_col(aes(Weight, Abundance)) +
    geom_line(aes(Weight, f_logw), color = "blue") +
    facet_grid(Species ~ .)
```
The fit looks reasonably good for the anchovy and not so good for the sardine
due to the long tail in the sardine observations.

However the picture changes very much when we plot the distribution of the
biomass in the stomach. Because the larger individuals contribute so much
more to the biomass, even low abundances at large size produce dominant
contributions to the biomass. This is a big problem for the anchovy
distribution with its narrower model distribution that fails to account 
for the possibility of small numbers of very large prey individuals.
```{r}
ggplot(binned) +
    geom_col(aes(Weight, Biomass)) +
    geom_line(aes(Weight, b_logw), color = "blue") +
    facet_grid(Species ~ .)
```
The broader sardine distribution has less of a problem with accounting for 
biomass at larger size but clearly gives a much broader distribution than
observed.
