---
title: "Estimating anchovy and sardine feeding kernel parameters"
output: html_notebook
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(bbmle)
library(mizer)
```

We load our params object
```{r}
params <- readRDS("params-2.rds")
```

# Load data

```{r eval=FALSE, include=FALSE}
stomach <- read_csv("Data_PPMR.csv") %>% 
    mutate(l = log(wpredator / wprey),
           Species = str_to_title(Species)) %>% 
    # ignore prey that are larger than the predator
    filter(l > 0) %>% 
    group_by(Species) %>% 
    mutate(weight_numbers = Nprey / sum(Nprey),
           weight_biomass = Nprey * wprey / sum(Nprey * wprey))
stomach
```
This has data for Anchovy and Sardine
```{r}
unique(stomach$Species)
```

  
# Bin the data
```{r}
no_bins <- 30  # Number of bins
binsize <- (max(stomach$l) - min(stomach$l)) / (no_bins - 1)
breaks <- seq(min(stomach$l) - binsize/2,
              by = binsize, length.out = no_bins + 1)
binned_stomach <- stomach %>% 
    # bin data
    mutate(cut = cut(l, breaks = breaks, right = FALSE,
                     labels = FALSE)) %>% 
    group_by(Species, cut) %>% 
    summarise(Numbers = sum(Nprey), 
              Biomass = sum(Nprey * wprey)) %>% 
    # normalise
    mutate(Numbers = Numbers / sum(Numbers) / binsize,
           Biomass = Biomass / sum(Biomass) / binsize)  %>%
    # column for predator/prey size ratio
    mutate(l = map_dbl(cut, function(idx) breaks[idx] + binsize/2)) %>% 
    gather(key = "Type", value = "Density", Numbers, Biomass)
```

# Normal distribution
Next we fit normal densities:
```{r}
weighted.sd <- function(x, w) {
  sqrt(sum(w * (x - weighted.mean(x, w))^2))
}
grid <- seq(0, max(stomach$l), length = 100)
normaldens <- plyr::ddply(stomach, "Species", function(df) {
  data.frame( 
    l = grid,
    density = dnorm(grid, 
                    mean = weighted.mean(df$l, df$weight_numbers),
                    sd = weighted.sd(df$l, df$weight_numbers))
  )
})

ggplot(stomach) +
    geom_density(aes(l, weight = weight_numbers), fill = "#00BFC4") +
    facet_wrap(~Species, scales = "free_y", ncol = 4) +
    xlab("Log of predator/prey mass ratio")  +
    geom_line(aes(l, density), data = normaldens,
                  colour = "blue")
```
Next we look at the biomass distribution. We plot the normal density arising
from the above fits on top of the observed biomass distribution.
```{r}
grid <- seq(-2, max(stomach$l), length = 100)
shifted_normaldens <- plyr::ddply(stomach, "Species", function(df) {
  data.frame( 
    l = grid,
    density = dnorm(grid, mean(df$l) - sd(df$l)^2, sd(df$l))
  )
})

ggplot(stomach) +
    geom_density(aes(l, weight = weight_biomass), fill = "#F8766D") +
    facet_wrap(~Species, scales = "free_y", ncol = 4) +
    xlab("Log of predator/prey mass ratio") +
    ylab("Biomass density") +
    geom_line(aes(l, density), data = shifted_normaldens,
                  colour = "red")
```
We see that this does not fit at all!



# Truncated exponential
We choose
$$
f_l(l) \propto \frac{\exp(\alpha\ l)}
{\left(1+e^{u_l(l_l - l)}\right)
\left(1+e^{u_r(l - l_r)}\right)}.
$$
```{r}
fl <- function(l, alpha, ll, ul, lr, ur) {
  dl <- ll - l
  dr <- l - lr
  fl <- exp(alpha * l) /
    (1 + exp(ul * dl)) /
    (1 + exp(ur * dr))
}
dtexp <- function(l, alpha, ll, ul, lr, ur) {
  d <- fl(l, alpha, ll, ul, lr, ur) /
    integrate(fl, 0, 30, alpha = alpha, 
              ll = ll, ul = ul, lr = lr, ur = ur)$value
  if (any(d <= 0)) {
    stop("The density contains non-positive values when",
         " alpha = ", alpha, " ll = ", ll, " ul = ", ul,
         " lr = ", lr, " ur = ", ur)
  }
  return(d)
}
```
We estimate the 5 parameters by maximum likelihood estimation, which in this
case can only be done numerically.
```{r}
mle_texp <- function(df) {
  loglik <- function(alpha, ll, ul, lr, ur) {
    L <- dtexp(df$l, alpha, ll, ul, lr, ur)
    - sum(log(L) * df$weight_numbers)
  }
  mle2(loglik, start = list(
    alpha = 0.5,
    ll = min(df$l),
    lr = max(df$l),
    ul = 5,
    ur = 5))
}
est <- stomach %>% 
  #filter(Species %in% select[c(1:3, 5:7)]) %>% 
  group_modify(~ broom::tidy(mle_texp(.x))) %>% 
  select(Species, term, estimate) %>% 
  spread(term, estimate)
est
```

```{r fig.height=15}
grid = seq(-2, max(stomach$l), length.out = 200)
texpdens <- plyr::ddply(est, "Species", function(df) {
  data.frame(
    l = grid,
    Numbers = dtexp(grid, df$alpha, df$ll, df$ul, df$lr, df$ur),
    Biomass = dtexp(grid, df$alpha - 1, df$ll, df$ul, df$lr, df$ur)
  )}) %>% 
  gather(Type, Density, Numbers, Biomass)

ggplot(binned_stomach) +
  geom_col(aes(l, Density, fill = Type)) +
  facet_grid(Species ~ Type, scales = "free_y") +
    xlab("Log of predator/prey mass ratio") +
    geom_line(aes(l, Density, colour = Type), data = texpdens)
```

```{r}
lambda <- 2.05
sp <- est %>% 
    transmute(kernel_exp = alpha + 4/3 - lambda,
              kernel_l_l = ll,
              kernel_u_l = ul,
              kernel_l_r = lr,
              kernel_u_r = ur)
sp
```
Letâ€™s take a look at the resulting kernels
```{r}
grid = seq(-1, max(stomach$l) + 1, length.out = 200)
phi <- plyr::ddply(sp, "Species", function(df) {
  data.frame(
    l = grid,
    y = power_law_pred_kernel(exp(grid),
                              kernel_exp = df$kernel_exp,
                              kernel_l_l = df$kernel_l_l,
                              kernel_l_r = df$kernel_l_r,
                              kernel_u_l = df$kernel_u_l,
                              kernel_u_r = df$kernel_u_r)
  )})

ggplot(binned_stomach) +
  facet_wrap(~Species, scales = "free_y") +
  xlab("Log of predator/prey mass ratio") +
  geom_line(aes(l, y), size = 3, data = phi) +
  theme(strip.text = element_text(size = 12))
```


Put the parameters into the params object
```{r}
for (i in seq_along(sp$Species)) {
  idx <- which(params@species_params$species == est$Species[i])
  params@species_params$pred_kernel_type[idx] = "power_law"
  params@species_params$kernel_exp[idx] <- sp$kernel_exp[i]
  params@species_params$kernel_l_l[idx] <- sp$kernel_l_l[i]
  params@species_params$kernel_l_r[idx] <- sp$kernel_l_r[i]
  params@species_params$kernel_u_l[idx] <- sp$kernel_u_l[i]
  params@species_params$kernel_u_r[idx] <- sp$kernel_u_r[i]
}
params <- setPredKernel(params)
```
```{r}
params <- tuneParams(params)
save(params, file = "params-2.rds")
```



