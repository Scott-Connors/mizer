library(shiny)
library(ggplot2)
# # Uncomment the following 3 lines before publishing the app
# library(devtools)
# install_github("gustavdelius/mizer", ref="scaling")
# library(mizer)
library(progress)

server <- function(input, output, session) {
    
    ## Load params object and store it as a reactive value
    data("humboldt_params")
    
    humboldt_params@species_params$SSB <- humboldt_params@species_params$w_mat
    no_sp <- length(humboldt_params@species_params$SSB)
    humboldt_params@species_params$SSB[] <- NA
    # this is a total hack, and I should have added the SSB into the underlying object, 
    # and I should not reply upon the ordering of the species.
    humboldt_params@species_params$SSB[(no_sp-7): no_sp] <- c(0.0186762374072649,
    0.000720757184972784,
    7.97858473029264e-05,
    2.51194830974027e-05,
    7.70690253424067e-06,
    0.000645875410082031,
    0.00023397243034225,
    0.000131377499657936)*0.1
    
    params <- reactiveVal()
    params(humboldt_params)
    
    ## Handle params object uploaded by user
    observeEvent(input$upload, {
        inFile <- input$upload
        load(inFile$datapath)
        params(humboldt_params)
    })
    
    ## Prepare for download of params object
    output$params <- downloadHandler(
        filename = "humboldt.RData", 
        content = function(file) {
            humboldt_params <- params()
            save(humboldt_params, file = file)
        })
    
    ## Create dynamic ui for species parameters
    output$sp_sel <- renderUI({
        p <- isolate(params())
        species <- as.character(p@species_params$species[!is.na(p@A)])
        selectInput("sp_sel", "Species:", species) 
    })
    output$params_sliders <- renderUI({
        req(input$sp_sel)
        sp <- params()@species_params[input$sp_sel, ]
        list(numericInput("gamma", "Predation rate coefficient gamma",
                          value = sp$gamma,
                          min = sp$gamma/10,
                          max = sp$gamma*2,
                          step = 1),
             numericInput("h", "max feeding rate h",
                          value = sp$h,
                          min = sp$h/10,
                          max = sp$h*2),
             numericInput("alpha", "Assimilation efficiency alpha",
                          value = sp$alpha,
                          min = 0,
                          max = 1, step = 10^(-2)),
             numericInput("ks", "Coefficient of standard metabolism ks",
                          value = sp$ks,
                          min = sp$ks/10,
                          max = sp$ks*2, 
                          step = 10^(-2)),
             numericInput("beta", "Preferred predator-prey mass ratio beta",
                          value = sp$beta,
                          min = 1.01,
                          max = sp$beta*100, 
                          step = 10^(-2)),
             numericInput("sigma", "Width of size selection function sigma",
                          value = sp$sigma,
                          min = sp$sigma/10,
                          max = sp$sigma*100, 
                          step = 10^(-2)),
             numericInput("k_vb", "von Bertalanffy parameter k_vb",
                          value = sp$k_vb,
                          min = sp$k_vb/10,
                          max = sp$k_vb*100, 
                          step = 10^(-2)),
             numericInput("a", "Coefficient for length to weight conversion a",
                          value = sp$a,
                          min = sp$a/10,
                          max = sp$a*10, 
                          step = 10^(-4)),
             numericInput("b", "Exponent for length to weight conversion b",
                          value = sp$b,
                          min = sp$b/10,
                          max = sp$b*100, 
                          step = 10^(-2)),
             numericInput("l50", "L50",
                          value = sp$l50,
                          min = 0,
                          max = 100, 
                          step = 1),
             numericInput("l25", "L25",
                          value = sp$l25,
                          min = 0,
                          max = 100, 
                          step = 1),
             numericInput("SSB", "Target SSB",
                          value = sp$SSB,
                          min = 10^(-20),
                          max = 10^4, 
                          step = 10^(-5))
             )
    })
    ## When a species parameter input is changed, only change that
    # parameter value in the params object and run to steady state
    # starting at previous steady state
    observeEvent(input$sp_go, {
        req(input$gamma, input$h)

        # Create a Progress object
        progress <- shiny::Progress$new(session)
        on.exit(progress$close())

        p <- params()
        # Create updated species params data frame
        species_params <- p@species_params
        species_params[input$sp_sel, "gamma"] <- input$gamma
        species_params[input$sp_sel, "h"]     <- input$h
        species_params[input$sp_sel, "alpha"] <- input$alpha
        species_params[input$sp_sel, "ks"]    <- input$ks
        species_params[input$sp_sel, "beta"]  <- input$beta
        species_params[input$sp_sel, "sigma"] <- input$sigma
        species_params[input$sp_sel, "k_vb"]  <- input$k_vb
        species_params[input$sp_sel, "a"]     <- input$a
        species_params[input$sp_sel, "b"]     <- input$b
        species_params[input$sp_sel, "l50"]   <- input$l50
        species_params[input$sp_sel, "l25"]   <- input$l25
        species_params[input$sp_sel, "SSB"]   <- input$SSB
        # Create new params object identical to old one except for changed #
        # species params 
        pc <- MizerParams(
            species_params,
            p = p@p,
            n = p@n,
            q = p@q,
            lambda = p@lambda,
            f0 = p@f0,
            kappa = p@kappa,
            min_w = min(p@w),
            max_w = max(p@w),
            no_w = length(p@w),
            min_w_pp = min(p@w_full),
            w_pp_cutoff = max(p@w_full),
            r_pp = (p@rr_pp / (p@w_full ^ (p@p - 1)))[1]
        )
        pc@linetype <- p@linetype
        pc@linecolour <- p@linecolour
        pc@A <- p@A
        pc@sc <- p@sc
        pc@cc_pp <- p@cc_pp
        pc@mu_b <- p@mu_b

        pc@initial_n <- p@initial_n
        pc@initial_n_pp <- p@initial_n_pp

        # Run to steady state
        #pc <- steady(pc, effort = input$effort, t_max = 100, tol = 1e-2,
        #             shiny_progress = progress)
        pc <- steady(pc, effort = c(knife_edge_gear = 0, sigmoid_gear = input$effort, sigmoid_gear_Anchovy = input$Anchovy_effort),
                     t_max = 100, tol = 1e-2,
                     shiny_progress = progress)
        # Update the reactive params object
        params(pc)
    })

    ## If a general parameter changes the entire params object is recalculated
    # from scratch
    observeEvent(input$bg_go, {

        # Create a Progress object
        progress <- shiny::Progress$new(session)
        on.exit(progress$close())

        p_old <- params()

        p <- setBackground(
            set_scaling_model(
                #min_w_pp = input$min_w_pp, no_sp = input$no_bg_sp, no_w = 400,
              min_w_pp = 1e-12, no_sp = input$no_bg_sp, no_w = 400,
                min_w_inf = 2, max_w_inf = 6e5,
                min_egg = 1e-4, min_w_mat = 2 / 10^0.6,
                lambda = input$lambda, knife_edge_size = Inf,
                f0 = input$f0, h = input$h_bkgd, r_pp = 10^input$log_r_pp
            )
        )
        # Loop over all foreground species and add them one-by-one to the new
        # background
        effort <- 0
        names(effort) <- "knife_edge_gear"
        all_efforts <- c(0, input$effort, input$Anchovy_effort)
        names(all_efforts) <- c("knife_edge_gear", "sigmoid_gear", "sigmoid_gear_Anchovy")
        no_sp <- length(p_old@A)
        for (sp in (1:no_sp)[!is.na(p_old@A)]) {
            if (!(p_old@species_params[sp, "gear"] %in% names(effort))) {
                effort <- c(effort, all_efforts[p_old@species_params[sp, "gear"]])
            }
            p <- addSpecies(p, p_old@species_params[sp, ],
                              effort = effort,
                          rfac=Inf, SSB=input$SSB)
            #p <- addSpecies(p, p_old@species_params[sp, ],
             #               effort = effort,
              #              rfac=Inf)
        }

        # Run to steady state
        p <- steady(p, effort = c(knife_edge_gear = 0, sigmoid_gear = input$effort, sigmoid_gear_Anchovy = input$Anchovy_effort), 
                    t_max = 100, tol = 1e-2,
                    shiny_progress = progress)
        # Update the reactive params object
        params(p)
    })
    
    # Run a simulation
    sim <- reactive({
        
        # Create a Progress object
        progress <- shiny::Progress$new(session)
        on.exit(progress$close())
        
        project(params(), t_max = 15, t_save = 0.1, 
                effort = c(knife_edge_gear = 0, sigmoid_gear = input$effort, 
                           sigmoid_gear_Anchovy = input$Anchovy_effort), 
                shiny_progress = progress)
    })
    
    # Run a simulation with homogenous fishing efforts
    sim_new <- reactive({
      
      # Create a Progress object
      progress <- shiny::Progress$new(session)
      on.exit(progress$close())
      
      project(params(), t_max = 15, t_save = 0.1, 
              effort = c(knife_edge_gear = 0, sigmoid_gear = input$effort, 
                         sigmoid_gear_Anchovy = input$new_Anchovy_effort), 
              shiny_progress = progress)
    })
    
    output$plotGrowthCurve <- renderPlot({
        plotGrowthCurves(params(), species = input$sp_sel)
    })
    
    output$plotSpectra <- renderPlot({
        plotSpectra(params(), total=TRUE)
    })
    
    output$plotBiomass <- renderPlot({
        plotBiomass(sim())
    })
    
    ###################
    
    #myfun <- function(params){params@w[1]}
    #output$printSSB <-  renderPrint({ sum(sim()@n[dim(sim@n)[1],] * sim()@params@w * sim()@params@dw * sim()@params@psi[1, ]) })
    #output$printSSB <-  renderPrint({ myfun(params()) })
    
   ## myfun <- function(sim){
        #res <- sim@params@species_params$w_mat
     ##   res <- sim@params@psi[,1]
      ##  for (i in (1:length(res))){
    ##        res[i] <- sum(sim@n[dim(sim@n)[1],i,] *sim@params@w * sim@params@dw * sim@params@psi[i, ])
     ##   }
      ##  names(res) <- names(sim@params@psi[,1])
    ##    return(res)
    ##}
    
    #output$printSSB <-  renderText({ 1:5})
    
    myfun <- function(sim){
    res <- sim@params@psi[,1]
    #res <- (1:length(sim@params@psi[,1]))
    for (i in (1:length(res))){
        res[i] <- sum(sim@n[dim(sim@n)[1],i,] *sim@params@w * sim@params@dw * sim@params@psi[i, ])
        
    }
    trueres <- matrix(0,nrow = length(res),ncol=3)
    trueres[,1] <- names(sim@params@psi[,1])
    trueres[,2] <- sim@params@species_params$SSB
    trueres[,3] <- res
    colnames(trueres) <- c("Species","Target SSB","Final SSB")
    rownames(trueres) <- names(sim@params@psi[,1])
    return(trueres)
    }
    
    ######################
    output$printSSB <-  renderTable({ myfun(sim())})
    
    
    output$plotSSB <- renderPlot({
      #b_new <- getSSB(sim_new())[, "Anchovy"]
      #b <- getSSB(sim())[, "Anchovy"]
      #plot((1:length(b_new))/10, b_new, sub="solid => Anchovy under old effort, dashed => Anchovy under new effort",xlab ="Time",
      #      ylab="SSB",type="l",lty=2)
      #lines((1:length(b))/10, b)
      
      # manual construction of SSB dataframe for ggplot (obselete, but I leave it i to remind)
      #b <- getSSB(sim())[, "Anchovy"]
      #b_new <- getSSB(sim_new())[, "Anchovy"]
      #b_df <- data.frame(
      #  #"Year" = rep((1:length(b))/10,2),
      #  "Year" = rep(as.numeric(names(b)),2),
      #  "Species" = rep(rep("Anchovy",length(b)),2),
      #  "SSB" = c(b,b_new),
      #  "Effort" = c(rep("Default",length(b)),rep("New",length(b)))
      #)
      
      b <- getSSBFrame(sim(), species="Anchovy")
      b_new <- getSSBFrame(sim_new(), species="Anchovy")
      b$Effort <- "Default"
      b_new$Effort <- "New"
      b_df <- rbind(b, b_new)
      
      
      ggplot(b_df) + 
        geom_line(aes(x = Year, y = SSB, colour = Species, linetype = Effort)) +
            scale_y_continuous(name="SSB [tonnes]", limits = c(0, NA)) +
          #  scale_colour_manual(values = params()@linecolour) +
            scale_linetype_manual(values = c("New" = "solid", "Default" = "dotted")) +
            theme(text = element_text(size = 18))
    })
   
    output$plotBiomasscomp <- renderPlot({
      ss <- sim()
      b <- getBiomassFrame(ss, species=ss@params@species_params$species[!is.na(ss@params@A)])
      b_new <- getBiomassFrame(sim_new(), species=ss@params@species_params$species[!is.na(ss@params@A)])
      b$Effort <- "Default"
      b_new$Effort <- "New"
      b_df <- rbind(b, b_new)
      ggplot(b_df) + 
        geom_line(aes(x = Year, y = Biomass, colour = Species, linetype = Effort)) +
        scale_y_continuous(name="Biomass [tonnes]", limits = c(0, NA)) +
          scale_colour_manual(values = params()@linecolour) +
        scale_linetype_manual(values = c("New" = "solid", "Default" = "dotted")) +
        theme(text = element_text(size = 18))
    })
    
    
     
    output$plot_erepro <- renderPlot({
        ggplot(params()@species_params, aes(x = species, y = erepro)) + 
            geom_col() + geom_hline(yintercept = 1, color="red")
    })

} #the server

#### user interface
ui <- fluidPage(
    
    titlePanel("Humboldt current ecosystem"),
    
    sidebarLayout(
        
        sidebarPanel(
            tabsetPanel(
                tabPanel("Species",
                    uiOutput("sp_sel"),
                    actionButton("sp_go", "Go"),
                    uiOutput("params_sliders")
                ),
                tabPanel("General",
                    actionButton("bg_go", "Go"),
                    numericInput("lambda", "Sheldon exponent",
                                value=2.12, min=1.9, max=2.2, step=0.005),
                    sliderInput("f0", "Feeding level",
                                value=0.6, min=0, max=1),
                    sliderInput("h_bkgd", "max feeding rate",
                                value=30, min=10, max=100, step=2),
                    sliderInput("log_r_pp", "log10 Plankton replenishment rate",
                                value=-1, min=-4, max=0),
                    sliderInput("no_bg_sp", "Number of background species",
                                value=10, min=4, max=20, step=1, round = TRUE),
                    numericInput("min_w_pp", "Minimum plankton weight min_w_pp",
                                value=1e-12,  step=1e-13)
                ),
                tabPanel("Fishing",
                    sliderInput("effort", "General Effort",
                                value=1.4, min=0.3, max=2),
                    sliderInput("Anchovy_effort", "Anchovy Effort",
                                value=1.1, min=0.3, max=2),
                         sliderInput("new_Anchovy_effort", "New Anchovy Effort",
                                     value=1.1, min=0.3, max=2)
                ),
                tabPanel("File",
                    downloadButton("params", "Download current params object"),
                    fileInput("upload", "Upload new params object")
                )
            )
        ),  # endsidebarpanel
        
        mainPanel(
            plotOutput("plot_erepro", height = "150px"),
            tabsetPanel(type = "tabs",
                tabPanel("Spectra", plotOutput("plotSpectra")),
                tabPanel("Growth", plotOutput("plotGrowthCurve")),
                tabPanel("Biomass", plotOutput("plotBiomass")),
                tabPanel("Biomass (perturbed)", plotOutput("plotBiomasscomp")),
                tabPanel("SSB Anchovy", plotOutput("plotSSB")),
                tabPanel("SSB targets", tableOutput("printSSB"))
            )
        )  # end mainpanel
    )  # end sidebarlayout
)

shinyApp(ui = ui, server = server) # this launches your app

# Got SSB table looking better
# I have added a function that plots a table for SSB. (1)) I need to improve the way SSB is inputted by 
# doing it through humboldt params, instead of hardcoding. Also, (2) I need to 
# understand why sliding SSB has little effect, and (3) I need to reindent, and clean up


