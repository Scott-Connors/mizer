---
title: "Oscillations triggered by larval mortality"
author: "Gustav Delius"
date: "9/25/2019"
output: pdf_document
fig_height: 4 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mizer)
```

# Setting up the model
We set up the model according to the description in the paper with the
parameters from Appendix B, but without diffusion. There is also some
uncertainty as to whether we chose the correct value for the strength
of predation (the A parameter in the paper).
```{r include=FALSE}
# Set up model ####
setAnchovyMort <- 
  function(params,
           # background mortality
           mu_0 = 1,
           w_0 = params@species_params$w_min,
           rho_b = -0.25,
           # Larval mortality
           mu_l = 0,
           w_l = 0.03,
           rho_l = 5,
           # Senescent mortality
           mu_s = 0.001,
           w_s = 0.5,
           rho_s = 1) {
    mu_b <- rep(0, length(params@w))
    mu_b[params@w <= w_s] <- (mu_0 * (params@w / w_0)^rho_b)[params@w < w_s]
    if (mu_0 > 0) {
      mu_s <- min(mu_b[params@w <= w_s])
    }
    mu_b[params@w >= w_s] <- (mu_s * (params@w / w_s)^rho_s)[params@w >= w_s]
    # Add larval mortality
    mu_b <- mu_b + mu_l / (1 + (params@w / w_l)^rho_l)
    
    params@mu_b[] <- mu_b
    return(params)
  }

plankton_logistic <- function(params, 
                              n = params@initial_n, 
                              n_pp = params@initial_n_pp, 
                              B = params@initial_B, 
                              rates = getRates(params), 
                              dt = 0.1, ...) {
    f <- params@rr_pp * n_pp * (1 - n_pp / params@cc_pp) + i - 
        rates$plankton_mort * n_pp 
    f[is.na(f)] <- 0
    return(n_pp + dt * f)
}

norm_box_pred_kernel <- function(ppmr, ppmr_min, ppmr_max) {
    phi <- rep(1, length(ppmr))
    phi[ppmr > ppmr_max] <- 0
    phi[ppmr < ppmr_min] <- 0
    # Do not allow feeding at own size
    phi[1] <- 0
    # normalise in log space
    logppmr <- log(ppmr)
    dl <- logppmr[2] - logppmr[1]
    N <- sum(phi) * dl
    phi <- phi / N
    return(phi)
}

setModel <- function(
  lambda = 2,
  q = 0.85,
  a0 = 100,
  r0 = 10,
  gamma = 1920 #1920,# * 75000
  ) {
  kappa = a0 * exp(-6.9*(lambda - 1))
  n = 2/3 # irrelevant value
  
  species_params <- data.frame(
    species = "Anchovy",
    w_min = 0.0003,
    w_mat = 10,
    m = 0.2 + n,
    w_inf = 66.5,
    erepro = 0.5,
    alpha = 0.1,
    ks = 0,
    gamma = gamma,
    ppmr_min = 100,
    ppmr_max = 30000,
    pred_kernel_type = "norm_box",
    h = Inf,
    r_max = Inf,
    linecolour = "brown")
  
  
  params <- set_multispecies_model(
    no_w = 200,
    species_params,
    lambda = lambda,
    kappa = kappa,
    w_pp_cutoff = 0.1,
    q = q,
    plankton_dynamics = plankton_logistic)
  
  rho <- 0.85
  params@rr_pp[] <- r0 * params@w_full^(rho - 1)
  return(params)
}

i0 <- 100
params <- setModel(a0 = 100, r0 = 10, q = 0.85, gamma = 750)
i <- i0 * params@w_full^(-params@lambda) * exp(-6.9*(params@lambda - 1))
```

# Without larval mortality or cannibalism
We first run the model without larval mortality and without cannibalism
```{r}
params <- setAnchovyMort(params, mu_l = 0)
params@interaction[] <- 0
```

We set an initial abundance and run for 10 years.
```{r}
params@initial_n[] <- 0.001 * params@w^(-1.8)
params@initial_n_pp[] <- params@cc_pp
sim <- project(params, t_max = 10, dt = 0.001)
plotSpectra(sim, power = 2, wlim = c(1e-8, NA), ylim = c(1e-5, NA))
```

At this point we reduce the anchovy abundance by an overall factor of 10^7
and then run the simulation for a further 30 years.

```{r}
sim@n[11, , ] <- sim@n[11, , ] / 10^7
sim <- project(sim, t_max = 30, dt = 0.001)
plotBiomass(sim)
```

## Figure 2a
```{r}
plotSpectra(sim, power = 2, wlim = c(1e-8, NA), ylim = c(1e-5, NA),
            time_range = 30)
```

This does not look exactly the same as the corresponding graph in the draft because the pile-up is not smoothed by diffusion, but it displays the same qualitative behaviour.

## Figure 2b
```{r}
no_t <- dim(sim@n)[1]
params@initial_n[] <- sim@n[no_t, , ]
params@initial_n_pp[] <- sim@n_pp[no_t, ]
mort <- getMort(params, effort = 0)
plot(mort[1, ], type = "l")
```

## Figure 2c
```{r}
abm <- getBiomass(sim)
pbm <- sim@n_pp %*% (params@w_full * params@dw_full)
plot(10:40, abm[11:41], type = "l", log = "y", ylim = c(1e-7, 1e2))
lines(10:40, pbm[11:41], col = "green")
```

# With cannibalism
Turn on cannibalism
```{r}
params@interaction[] <- 1
```

We set an initial abundance and run for 10 years.
```{r}
params@initial_n[] <- 0.001 * params@w^(-1.8)
params@initial_n_pp[] <- params@cc_pp
simc <- project(params, t_max = 10, dt = 0.001)
plotSpectra(simc, power = 2, wlim = c(1e-8, NA), ylim = c(1e-5, NA))
```

At this point we reduce the anchovy abundance by an overall factor of 10^7
and then run the simulation for a further 30 years.

```{r}
simc@n[11, , ] <- simc@n[11, , ] / 10^7
simc <- project(simc, t_max = 30, dt = 0.001)
plotBiomass(simc)
```

## Figure 2d
```{r}
params@initial_n[] <- simc@n[no_t, , ]
params@initial_n_pp[] <- simc@n_pp[no_t, ]
mort <- getMort(params, effort = 0)
plot(mort[1, ], type = "l")
```

## Figure 2e
```{r}
abm <- getBiomass(simc)
pbm <- simc1@n_pp %*% (params@w_full * params@dw_full)
plot(10:40, abm[11:41], type = "l", log = "y", ylim = c(1e-7, 1e2))
lines(10:40, pbm[11:41], col = "green")
```