---
title: "Oscillations triggered by larval mortality"
author: "Gustav Delius"
date: "9/25/2019"
output: pdf_document
fig_height: 4 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mizer)
```

We set up the model according to the description in the draft with the
parameters from the tables, but without diffusion. There is also some
uncertainty as to whether we chose the correct value for the strength
of predation (the A parameter in the paper).
```{r include=FALSE}
# Set up model ####
setAnchovyMort <- 
  function(params,
           # background mortality
           mu_0 = 1,
           w_0 = params@species_params$w_min,
           rho_b = -0.25,
           # Larval mortality
           mu_l = 0,
           w_l = 0.03,
           rho_l = 5,
           # Senescent mortality
           mu_s = 0.001,
           w_s = 0.5,
           rho_s = 1) {
    mu_b <- rep(0, length(params@w))
    mu_b[params@w <= w_s] <- (mu_0 * (params@w / w_0)^rho_b)[params@w < w_s]
    if (mu_0 > 0) {
      mu_s <- min(mu_b[params@w <= w_s])
    }
    mu_b[params@w >= w_s] <- (mu_s * (params@w / w_s)^rho_s)[params@w >= w_s]
    # Add larval mortality
    mu_b <- mu_b + mu_l / (1 + (params@w / w_l)^rho_l)
    
    params@mu_b[] <- mu_b
    return(params)
  }

plankton_logistic <- function(params, 
                              n = params@initial_n, 
                              n_pp = params@initial_n_pp, 
                              B = params@initial_B, 
                              rates = getRates(params), 
                              dt = 0.1, ...) {
    f <- params@rr_pp * n_pp * (1 - n_pp / params@cc_pp) + i - 
        rates$plankton_mort * n_pp 
    f[is.na(f)] <- 0
    return(n_pp + dt * f)
}

norm_box_pred_kernel <- function(ppmr, ppmr_min, ppmr_max) {
    phi <- rep(1, length(ppmr))
    phi[ppmr > ppmr_max] <- 0
    phi[ppmr < ppmr_min] <- 0
    # Do not allow feeding at own size
    phi[1] <- 0
    # normalise in log space
    logppmr <- log(ppmr)
    dl <- logppmr[2] - logppmr[1]
    N <- sum(phi) * dl
    phi <- phi / N
    return(phi)
}

setModel <- function(
  lambda = 2,
  q = 0.85,
  a0 = 100,
  r0 = 10,
  gamma = 1920 #1920,# * 75000
  ) {
  kappa = a0 * exp(-6.9*(lambda - 1))
  n = 2/3 # irrelevant value
  
  species_params <- data.frame(
    species = "Anchovy",
    w_min = 0.0003,
    w_mat = 10,
    m = 0.2 + n,
    w_inf = 66.5,
    erepro = 0.5,
    alpha = 0.1,
    ks = 0,
    gamma = gamma,
    ppmr_min = 100,
    ppmr_max = 30000,
    pred_kernel_type = "norm_box",
    h = Inf,
    r_max = Inf,
    linecolour = "brown")
  
  
  params <- set_multispecies_model(
    no_w = 200,
    species_params,
    lambda = lambda,
    kappa = kappa,
    w_pp_cutoff = 0.1,
    q = q,
    plankton_dynamics = plankton_logistic)
  
  params@rr_pp[] <- r0 * params@w_full^(0.85 - 1)
  return(params)
}

i0 <- 10
params <- setModel(a0 = 100, r0 = 10, q = 0.85, gamma = 750)
i <- i0 * params@w_full^(-params@lambda) * exp(-6.9*(params@lambda - 1))
# initial anchovy abundance
params@initial_n[] <- 0.001 * params@w^(-1.8)
params@initial_n_pp[] <- params@cc_pp
```
We first run the model without larval mortality and without cannibalism for 40 years.
```{r}
params <- setAnchovyMort(params, mu_l = 0)
params@interaction[] <- 0
sim <- project(params, t_max = 40, dt = 0.001)
plotSpectra(sim, power = 2, ylim = c(1e-5, NA))
```

This does not look exactly the same as the corresponding graph in the draft because the pile-up is not smoothed by diffusion, but it displays the same qualitative behaviour.

Running the simulation for 60 more years and looking at the anchovy biomass indicates that this appears to be a steady state.
```{r}
sim2 <- project(sim, t_max = 60, dt = 0.001)
plotBiomass(sim2)
```


Next we switch on the larval mortality, with parameters as in the paper ($\mu_l = 21$), but leave cannibalism switched off, so that the mortality looks like this:
```{r}
params <- setAnchovyMort(params, mu_l = 21)
params@interaction[] <- 0
mu <- getMort(params, effort = 0)[1, ]
plot(params@w, mu, type = "l", log = "x")
```
We run the simulation for 40 years and plot the anchovy biomass over time:
```{r include=FALSE}
# initial anchovy abundance
params@initial_n[] <- 0.001 * params@w^(-1.8)
params@initial_n_pp[] <- params@cc_pp
```
```{r}
sim <- project(params, t_max = 40, dt = 0.001)
plotBiomass(sim)
```

This clearly shows regular oscillations.

Let's look at the size spectrum in year 7 (the second peak)
```{r}
plotSpectra(sim, wlim = c(1e-10, NA), power = 2, ylim = c(1e-5, NA),
              time_range = 7)
```

This shows a very pronounced pile-up below maturity size. The anchovy is set up for collapse. Next we look at the spectrum
 in year 9 (the second trough)
```{r}
plotSpectra(sim, wlim = c(1e-10, NA), power = 2, ylim = c(1e-5, NA),
              time_range = 9)
```

The pile up has disappeared and there is high abundance above maturity size. The anchovy is set up for recovery.